<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futbol Maç Sonucu Tahmin Sistemi (1X2)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #181c24 0%, #232946 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .main-container {
            background: rgba(30, 32, 40, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            margin: 20px 0;
        }
        .header-section {
            background: linear-gradient(135deg, #232946 0%, #1a1f2b 100%);
            color: #f7c873;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            border-bottom: 2px solid #232946;
        }
        .nav-tabs {
            border-bottom: 2px solid #232946;
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            padding: 12px 20px;
            font-weight: 600;
            color: #bfc9d1;
            background: #232946;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #f7c873 0%, #f7b267 100%);
            color: #232946;
        }
        .feature-card {
            background: #232946;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #f7c873;
            color: #e0e0e0;
        }
        .result-card {
            background: linear-gradient(135deg, #232946 0%, #181c24 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.18);
            border-left: 5px solid #f7c873;
            color: #e0e0e0;
        }
        .prediction-card {
            background: linear-gradient(135deg, #232946 0%, #181c24 100%);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #f7c873;
            color: #e0e0e0;
        }
        .metric-card {
            background: linear-gradient(135deg, #393e4c 0%, #232946 100%);
            color: #f7c873;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .match-card {
            background: linear-gradient(135deg, #232946 0%, #181c24 100%);
            border-radius: 15px;
            padding: 20px;
            border-left: 4px solid #f7c873;
            color: #e0e0e0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.18);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }
        .match-header {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #f7c873;
        }
        .match-teams {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        .match-prediction {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #393e4c;
        }
        .match-date {
            font-size: 0.9rem;
            color: #bfc9d1;
        }
        .match-countdown {
            font-size: 0.9rem;
            color: #f7c873;
            font-weight: 600;
        }
        .prediction-badge {
            background: linear-gradient(135deg, #f7c873 0%, #f7b267 100%);
            color: #232946;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .confidence-badge {
            background: #393e4c;
            color: #f7c873;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        .btn-custom {
            background: linear-gradient(135deg, #f7c873 0%, #f7b267 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            color: #232946;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(247,200,115,0.2);
            color: #232946;
        }
        .btn-predict {
            background: linear-gradient(135deg, #393e4c 0%, #232946 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            color: #f7c873;
            font-weight: 600;
        }
        .btn-predict:hover {
            background: linear-gradient(135deg, #f7c873 0%, #f7b267 100%);
            color: #232946;
        }
        .loading {
            background: #232946;
            color: #f7c873;
        }
        .week-chip {
            display: inline-block;
            background: #393e4c;
            color: #f7c873;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 3px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .match-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            background: #232946;
            color: #e0e0e0;
            border: 1px solid #393e4c;
        }
        .match-correct {
            background: linear-gradient(135deg, #1a2a1a 0%, #232946 100%);
            border-left: 4px solid #43d17a;
        }
        .match-wrong {
            background: linear-gradient(135deg, #2a1a1a 0%, #232946 100%);
            border-left: 4px solid #e05f5f;
        }
        .match-unplayed {
            border-left: 4px solid #f7c873;
            background: linear-gradient(135deg, #2a241a 0%, #232946 100%);
        }
        .prediction-group {
            display: flex;
            align-items: center;
        }
        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #000 !important;
        }
        .badge.bg-primary {
            background-color: #f7c873 !important;
            color: #232946 !important;
        }
        .badge.bg-success {
            background-color: #43d17a !important;
            color: #232946 !important;
        }
        .badge.bg-warning {
            background-color: #ffe066 !important;
            color: #232946 !important;
        }
        .badge.bg-secondary {
            background-color: #393e4c !important;
            color: #f7c873 !important;
        }
        .badge.bg-danger {
            background-color: #e05f5f !important;
            color: #fff !important;
        }
        .alert {
            background: #232946;
            color: #ffe066;
            border: 1px solid #ffe066;
        }
        input, select, textarea {
            background: #181c24 !important;
            color: #f7c873 !important;
            border: 1px solid #393e4c !important;
        }
        input:focus, select:focus, textarea:focus {
            background: #232946 !important;
            color: #ffe066 !important;
            border: 1px solid #f7c873 !important;
        }
        ::placeholder {
            color: #bfc9d1 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section">
                <h1><i class="fas fa-futbol"></i> Futbol Maç Sonucu Tahmin Sistemi</h1>
                <p class="mb-0">1X2 Sonuç Tahmini (Sadece Galibiyetli/Beraberlik/Mağlubiyet)</p>
            </div>

            <div class="p-4">
                    <!-- Parametric Backtest -->
                    <div class="feature-card">
                        <h3><i class="fas fa-calendar-week"></i> Parametric Backtest</h3>
                        <p>Herhangi bir hafta için model performansını test edin veya oynanmamış maçları tahmin edin.</p>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="weekSelect" class="form-label">Test Haftası:</label>
                                    <select id="weekSelect" class="form-select">
                                        <option value="">Hafta seçin...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="dataFile" class="form-label">Veri Dosyası:</label>
                                    <select id="dataFile" class="form-select">
                                        <option value="data/ALM_stat.json">🇩🇪 Alman Ligi (Bundesliga)</option>
                                        <option value="data/BEL_stat.json">🇧🇪 Belçika Ligi</option>
                                        <option value="data/BRA_stat.json">🇧🇷 Brezilya Ligi</option>
                                        <option value="data/ENG_stat.json">🏴 İngiliz Premier Ligi</option>
                                        <option value="data/ENG_C_stat.json">🏴 İngiliz Championship</option>
                                        <option value="data/ESP_stat.json">🇪🇸 İspanya La Liga</option>
                                        <option value="data/FRA_stat.json">🇫🇷 Fransa Ligue 1</option>
                                        <option value="data/HOL_stat.json">🇳🇱 Hollanda Eredivisie</option>
                                        <option value="data/HOL_2_stat.json">🇳🇱 Hollanda 2. Lig</option>
                                        <option value="data/POR_stat.json">🇵🇹 Portekiz Ligi</option>
                                        <option value="data/TR_stat.json">🇹🇷 Türkiye Süper Lig</option>
                                        <option value="data/ISVEC_stat.json">🇸🇪 İsveç Ligi</option>
                                        <option value="data/NORVEC_stat.json">🇳🇴 Norveç Ligi</option>
                                        <option value="data/FINLANDIYA_stat.json">🇫🇮 Finlandiya Ligi</option>
                                        <option value="data/JAP_stat.json">🇯🇵 Japonya J-League</option>
                                        <option value="data/GK_stat.json">🌍 Güney Kore K-League</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button id="runBacktest" class="btn btn-custom me-2">
                                    <i class="fas fa-play"></i> Backtest Çalıştır
                                </button>
                                <button id="testDeterminism" class="btn btn-warning me-2">
                                    <i class="fas fa-sync-alt"></i> Determinizm Testi
                                </button>
                                <button id="clearHistory" class="btn btn-outline-danger me-2">
                                    <i class="fas fa-trash"></i> Temizle
                                </button>
                                <button id="exportResults" class="btn btn-outline-success">
                                    <i class="fas fa-download"></i> Sonuçları İndir
                                </button>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div id="backtestLoading" class="loading" style="display:none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Backtest çalıştırılıyor...</p>
                        </div>

                        <!-- Results -->
                        <div id="backtestResults" style="display: none;">
                            <div class="row" id="backtestMetrics"></div>
                            <div class="result-card">
                                <h4><i class="fas fa-list"></i> Maç Sonuçları</h4>
                                <div id="backtestMatches"></div>
                            </div>
                        </div>

                        <!-- Available Weeks -->
                        <div class="feature-card">
                            <h5><i class="fas fa-info-circle"></i> Mevcut Haftalar</h5>
                            <div id="availableWeeks"></div>
                        </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global değişkenler
        let availableWeeks = [];
        
        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableWeeks();
            
            // Veri dosyası değiştiğinde haftaları yeniden yükle
            document.getElementById('dataFile').addEventListener('change', function() {
                loadAvailableWeeks(this.value);
            });
            
            document.getElementById('unplayedDataFile').addEventListener('change', function() {
                loadAvailableWeeks(this.value);
            });
            
            // Sayfa ilk açılışta loader ve sonuçlar gizli olsun
            hideLoading('backtestLoading');
            hideElement('backtestResults');
            hideElement('unplayedResults');
        });

        // Mevcut haftaları yükle
        async function loadAvailableWeeks(dataFile = null) {
            try {
                const selectedDataFile = dataFile || document.getElementById('dataFile').value || 'data/ALM_stat.json';
                const response = await fetch(`/api/available-weeks?data_file=${encodeURIComponent(selectedDataFile)}`);
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                    return;
                }
                
                availableWeeks = data.weeks;
                
                // Hafta seçiciyi doldur
                const weekSelect = document.getElementById('weekSelect');
                weekSelect.innerHTML = '<option value="">Hafta seçin...</option>';
                
                data.weeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week;
                    option.textContent = `${week}. Hafta`;
                    weekSelect.appendChild(option);
                });
                
                // Mevcut haftaları göster
                const availableWeeksDiv = document.getElementById('availableWeeks');
                availableWeeksDiv.innerHTML = data.weeks.map(week => 
                    `<span class="week-chip" onclick="selectWeek(${week})">${week}</span>`
                ).join('');
                
                const leagueInfo = data.league || 'Bilinmeyen Lig';
                // Başarı mesajı kaldırıldı - sadece hata mesajları gösterilecek
                
            } catch (error) {
                showAlert('danger', 'Haftalar yüklenirken hata: ' + error.message);
            }
        }

        // Hafta seç
        function selectWeek(week) {
            document.getElementById('weekSelect').value = week;
        }

        // Parametric Backtest Çalıştır
        document.getElementById('runBacktest').addEventListener('click', async function() {
            const week = document.getElementById('weekSelect').value;
            const dataFile = document.getElementById('dataFile').value;
            
            if (!week) {
                showAlert('warning', 'Lütfen bir hafta seçin');
                return;
            }
            
            showLoading('backtestLoading');
            hideElement('backtestResults');
            
            try {
                const response = await fetch('/api/run-backtest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        week: parseInt(week),
                        data_file: dataFile
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                    return;
                }
                
                // Eğer sadece oynanmamış maç tahmini varsa
                if (data.unplayed_predictions) {
                    const matchesDiv = document.getElementById('backtestMatches');
                    
                    // Maçları yüzdeye göre sırala (en yüksek önce)
                    const sortedMatches = data.unplayed_predictions.map((match) => {
                        const name = match[0];
                        const predData = match[1];
                        const homeWinProbNum = typeof predData.home_win_prob === 'number' ? predData.home_win_prob : 0;
                        const drawProbNum = typeof predData.draw_prob === 'number' ? predData.draw_prob : 0;
                        const awayWinProbNum = typeof predData.away_win_prob === 'number' ? predData.away_win_prob : 0;
                        const maxProb = Math.max(homeWinProbNum, drawProbNum, awayWinProbNum);
                        return { match, name, predData, maxProb };
                    }).sort((a, b) => b.maxProb - a.maxProb);
                    
                    matchesDiv.innerHTML = `
                        <div class="match-grid">
                            ${sortedMatches.map((item) => {
                                const { name, predData } = item;
                                
                                // Yeni 1X2 format için güvenli erişim
                                const result = predData.predicted_result || 'N/A';
                                const resultMeaning = predData.result_meaning || 'Bilinmeyen';
                                const homeWinProb = typeof predData.home_win_prob === 'number' ? (predData.home_win_prob * 100).toFixed(0) + '%' : (predData.home_win_prob || '0%');
                                const drawProb = typeof predData.draw_prob === 'number' ? (predData.draw_prob * 100).toFixed(0) + '%' : (predData.draw_prob || '0%');
                                const awayWinProb = typeof predData.away_win_prob === 'number' ? (predData.away_win_prob * 100).toFixed(0) + '%' : (predData.away_win_prob || '0%');
                                const confidence = typeof predData.confidence === 'number' ? (predData.confidence * 100).toFixed(0) + '%' : (predData.confidence || '0%');
                                
                                // En yüksek olasılığı bul
                                const homeWinProbNum = typeof predData.home_win_prob === 'number' ? predData.home_win_prob : 0;
                                const drawProbNum = typeof predData.draw_prob === 'number' ? predData.draw_prob : 0;
                                const awayWinProbNum = typeof predData.away_win_prob === 'number' ? predData.away_win_prob : 0;
                                
                                let highestProb = '';
                                let highestValue = Math.max(homeWinProbNum, drawProbNum, awayWinProbNum);
                                
                                if (homeWinProbNum === highestValue) {
                                    highestProb = 'MS 1: ' + homeWinProb;
                                } else if (drawProbNum === highestValue) {
                                    highestProb = 'MS X: ' + drawProb;
                                } else {
                                    highestProb = 'MS 2: ' + awayWinProb;
                                }
                                
                                // Tarih ve saat bilgisi
                                const matchDate = predData.date || 'Tarih belirtilmemiş';
                                const matchTime = predData.time || '--:--';
                                const timeUntilMatch = calculateTimeUntilMatch(matchDate, matchTime);
                                
                                return `
                                    <div class="match-card">
                                        <div class="match-header">
                                            <i class="fas fa-calendar-day"></i> ${matchDate} - ${matchTime}
                                        </div>
                                        <div class="match-teams">${name}</div>
                                        <div class="match-prediction">
                                            <span class="prediction-badge">${highestProb}</span>
                                            <span class="confidence-badge">Güven: ${confidence}</span>
                                        </div>
                                        <div class="match-info">
                                            <div class="match-date">
                                                <i class="fas fa-clock"></i> ${resultMeaning}
                                            </div>
                                            <div class="match-countdown">
                                                ${timeUntilMatch}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    document.getElementById('backtestMetrics').innerHTML = `<div class="col-12"><div class="alert alert-info">Bu haftada sadece oynanmamış maçlar için tahmin üretildi.</div></div>`;
                    showElement('backtestResults');
                    return;
                }
                
                // Normal backtest sonuçları
                if (data.result && data.result.matches) {
                    displayBacktestResults(data.result);
                } else if (data.matches) {
                    displayBacktestResults(data);
                } else {
                    showAlert('warning', 'Backtest sonuçları bulunamadı');
                }
                
                showElement('backtestResults');
                
                // Normal backtest sonuçlarını göster
                if (data.result) {
                    displayBacktestResults(data.result);
                    // Başarı mesajı kaldırıldı - sadece hata mesajları gösterilecek
                } else {
                    showAlert('warning', 'Backtest tamamlandı ama sonuç verisi eksik.');
                    console.log('Gelen veri yapısı:', data);
                }
                
            } catch (error) {
                showAlert('danger', 'Backtest hatası: ' + error.message);
                console.error('Backtest error details:', error);
            } finally {
                hideLoading('backtestLoading');
            }
        });

        // Sonuçları göster fonksiyonları
        function displayBacktestResults(result) {
            // Güvenli metrics erişimi
            const metrics = result && result.metrics ? result.metrics : null;
            
            if (!metrics) {
                document.getElementById('backtestMetrics').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Metrik verileri yüklenemedi. Sonuç yapısı: ${JSON.stringify(result)}
                        </div>
                    </div>
                `;
                return;
            }
            
            document.getElementById('backtestMetrics').innerHTML = `
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${metrics.exact_matches || 0}</div>
                        <div>Doğru Tahmin</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${metrics.accuracy ? (metrics.accuracy * 100).toFixed(1) + '%' : '0%'}</div>
                        <div>Başarı Oranı</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${metrics.close_rate ? (metrics.close_rate * 100).toFixed(1) + '%' : '0%'}</div>
                        <div>Yakın Tahmin</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">${metrics.result_accuracy ? (metrics.result_accuracy * 100).toFixed(1) + '%' : '0%'}</div>
                        <div>Sonuç Doğruluk</div>
                    </div>
                </div>
            `;
            
            // Güvenli predictions erişimi
            const predictions = result && result.predictions ? result.predictions : [];
            
            if (predictions.length === 0) {
                document.getElementById('backtestMatches').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Maç tahmin verileri bulunamadı.
                    </div>
                `;
            } else {
                document.getElementById('backtestMatches').innerHTML = predictions.map(([name, pred, actual]) => {
                    // Güvenli veri kontrolü
                    const safeName = name || 'Bilinmeyen Maç';
                    
                    // Yeni 1X2 format kontrolü
                    let predResult, actualResult, isCorrect;
                    
                    if (typeof pred === 'object' && pred.predicted_result) {
                        // Yeni 1X2 format
                        predResult = pred.predicted_result;
                        const predMeaning = pred.result_meaning || 'Bilinmeyen';
                        const confidence = typeof pred.confidence === 'number' ? (pred.confidence * 100).toFixed(0) + '%' : (pred.confidence || '0%');
                        const homeWinProb = typeof pred.home_win_prob === 'number' ? (pred.home_win_prob * 100).toFixed(0) + '%' : (pred.home_win_prob || '0%');
                        const drawProb = typeof pred.draw_prob === 'number' ? (pred.draw_prob * 100).toFixed(0) + '%' : (pred.draw_prob || '0%');
                        const awayWinProb = typeof pred.away_win_prob === 'number' ? (pred.away_win_prob * 100).toFixed(0) + '%' : (pred.away_win_prob || '0%');
                        
                        // En yüksek olasılığı bul
                        const homeWinProbNum = typeof pred.home_win_prob === 'number' ? pred.home_win_prob : 0;
                        const drawProbNum = typeof pred.draw_prob === 'number' ? pred.draw_prob : 0;
                        const awayWinProbNum = typeof pred.away_win_prob === 'number' ? pred.away_win_prob : 0;
                        
                        let highestProb = '';
                        let highestValue = Math.max(homeWinProbNum, drawProbNum, awayWinProbNum);
                        
                        if (homeWinProbNum === highestValue) {
                            highestProb = `MS 1: ${homeWinProb}`;
                        } else if (drawProbNum === highestValue) {
                            highestProb = `MS X: ${drawProb}`;
                        } else {
                            highestProb = `MS 2: ${awayWinProb}`;
                        }
                        
                        // Gerçek sonucu hesapla
                        if (Array.isArray(actual) && actual.length >= 2) {
                            const homeScore = actual[0];
                            const awayScore = actual[1];
                            if (homeScore > awayScore) actualResult = '1';
                            else if (homeScore === awayScore) actualResult = 'X';
                            else actualResult = '2';
                        } else {
                            actualResult = 'N/A';
                        }
                        
                        isCorrect = predResult === actualResult;
                        
                        return `
                            <div class="match-result ${isCorrect ? 'match-correct' : 'match-wrong'}">
                                <div class="mb-2"><strong>${safeName}</strong></div>
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div class="prediction-group mb-1">
                                        <span class="badge ${isCorrect ? 'bg-success' : 'bg-danger'} me-1">${predResult} - ${predMeaning}</span>
                                        <i class="fas fa-chevron-right text-muted mx-1"></i>
                                        <span class="badge ${isCorrect ? 'bg-success' : 'bg-danger'}">${actualResult}</span>
                                    </div>
                                    <div class="prediction-group mb-1">
                                        <small class="text-muted">Güven: ${confidence}</small>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-center gap-1 mt-1">
                                    <small class="badge bg-success text-white">${highestProb}</small>
                                </div>
                            </div>
                        `;
                    } else {
                        // Eski score-based format (geriye dönük uyumluluk)
                        const safePred = pred || [0, 0];
                        const safeActual = actual || [0, 0];
                        
                        const isScoreCorrect = safePred[0] === safeActual[0] && safePred[1] === safeActual[1];
                        
                        // Maç sonucu hesapla (1X2)
                        const getMatchResult = (homeScore, awayScore) => {
                            if (homeScore > awayScore) return "1";
                            if (homeScore === awayScore) return "X";
                            return "2";
                        };
                        
                        const predMatchResult = getMatchResult(safePred[0], safePred[1]);
                        const actualMatchResult = getMatchResult(safeActual[0], safeActual[1]);
                        const isMatchResultCorrect = predMatchResult === actualMatchResult;
                        
                        return `
                            <div class="match-result ${isScoreCorrect ? 'match-correct' : 'match-wrong'}">
                                <div class="mb-2"><strong>${safeName}</strong></div>
                                <div class="d-flex justify-content-between align-items-center flex-wrap">
                                    <div class="prediction-group mb-1">
                                        <span class="badge ${isScoreCorrect ? 'bg-success' : 'bg-danger'} me-1">${safePred[0]}-${safePred[1]}</span>
                                        <i class="fas fa-chevron-right text-muted mx-1"></i>
                                        <span class="badge ${isScoreCorrect ? 'bg-success' : 'bg-danger'} me-3">${safeActual[0]}-${safeActual[1]}</span>
                                    </div>
                                    <div class="prediction-group mb-1">
                                        <span class="badge ${isMatchResultCorrect ? 'bg-success' : 'bg-danger'} me-1">${predMatchResult}</span>
                                        <i class="fas fa-chevron-right text-muted mx-1"></i>
                                        <span class="badge ${isMatchResultCorrect ? 'bg-success' : 'bg-danger'}">${actualMatchResult}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            
            showElement('backtestResults');
        }

        // Yardımcı fonksiyonlar
        function calculateTimeUntilMatch(matchDate, matchTime) {
            try {
                // Şimdilik basit bir format döndür
                if (!matchDate || matchDate === 'Tarih belirtilmemiş') {
                    return '<i class="fas fa-question"></i> Tarih bilinmiyor';
                }
                
                // Basit tarih formatı için
                const now = new Date();
                return '<i class="fas fa-hourglass-half"></i> Yakında';
            } catch (error) {
                return '<i class="fas fa-exclamation"></i> Hesaplanamadı';
            }
        }
        
        // DataTables ile oynanmamış maçları göster
        function displayUnplayedMatchesInDataTable(unplayedPredictions) {
            // Eğer DataTable zaten varsa, yok et
            if ($.fn.DataTable.isDataTable('#matchResultsTable')) {
                $('#matchResultsTable').DataTable().destroy();
            }
            
            // Tablo verilerini hazırla
            const tableData = unplayedPredictions.map((match) => {
                const name = match[0];
                const predData = match[1];
                
                const result = predData.predicted_result || 'N/A';
                const resultMeaning = predData.result_meaning || 'Bilinmeyen';
                const homeWinProb = typeof predData.home_win_prob === 'number' ? (predData.home_win_prob * 100).toFixed(0) : '0';
                const drawProb = typeof predData.draw_prob === 'number' ? (predData.draw_prob * 100).toFixed(0) : '0';
                const awayWinProb = typeof predData.away_win_prob === 'number' ? (predData.away_win_prob * 100).toFixed(0) : '0';
                const confidence = typeof predData.confidence === 'number' ? (predData.confidence * 100).toFixed(0) : '0';
                
                const matchDate = predData.date || 'Tarih belirtilmemiş';
                const timeUntilMatch = 'Oynanmamış';
                
                return [
                    matchDate,
                    name,
                    `<span class="badge bg-primary">${result}</span>`,
                    '<span class="badge bg-secondary">-</span>',
                    '<span class="badge bg-warning">Bekleniyor</span>',
                    confidence,
                    homeWinProb,
                    drawProb,
                    awayWinProb,
                    `<span class="badge bg-info">${timeUntilMatch}</span>`
                ];
            });
            
            // DataTable oluştur
            $('#matchResultsTable').DataTable({
                data: tableData,
                order: [[5, 'desc']], // Güven yüzdesine göre sırala
                pageLength: 25,
                responsive: true,
                language: {
                    url: '/static/js/turkish.json'
                },
                columnDefs: [
                    { targets: [2, 3, 4, 9], orderable: false }, // Badge kolonları sıralama dışı
                    { targets: [5, 6, 7, 8], type: 'num' } // Yüzde kolonları sayısal
                ]
            });
        }
        
        // Gereksiz DataTables fonksiyonları kaldırıldı - kart tabanlı arayüz kullanılıyor
        
        function showLoading(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function showElement(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideElement(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const header = document.querySelector('.header-section');
            header.parentNode.insertBefore(alertDiv, header.nextSibling);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Diğer butonlar
        document.getElementById('testDeterminism').addEventListener('click', async function() {
            const week = document.getElementById('weekSelect').value;
            const dataFile = document.getElementById('dataFile').value;
            
            if (!week) {
                showAlert('warning', 'Lütfen bir hafta seçin');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test ediliyor...';
            
            try {
                const response = await fetch('/api/test-determinism', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        week: parseInt(week),
                        data_file: dataFile,
                        seed: 42
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showAlert('danger', data.error);
                    return;
                }
                
                if (data.is_deterministic) {
                    // Başarı mesajı kaldırıldı - sadece hata mesajları gösterilecek
                } else {
                    showAlert('danger', `❌ Determinizm Testi BAŞARISIZ! ${data.comparison_info}`);
                }
                
            } catch (error) {
                showAlert('danger', 'Determinizm testi hatası: ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Determinizm Testi';
            }
        });

        document.getElementById('clearHistory').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/clear-history', { method: 'POST' });
                const data = await response.json();
                
                hideElement('backtestResults');
                // Başarı mesajı kaldırıldı - sadece hata mesajları gösterilecek
                
            } catch (error) {
                showAlert('danger', 'Temizleme hatası: ' + error.message);
            }
        });

        // Gereksiz DataTables fonksiyonları kaldırıldı - kart tabanlı arayüz kullanılıyor

        document.getElementById('exportResults').addEventListener('click', function() {
            window.open('/api/export-results', '_blank');
        });
    </script>
</body>
</html>